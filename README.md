# Cost Calculation API

Микросервис на Sinatra, подсчитывающий приблизительную стоимость поездки по выбранному тарифу. Взаимодействует с микросервисом, оценивающим длину и продолжительность поездки по заданным координатам. Поддерживает несколько тарифов, которые можно задавать в файле config/tariffs.yml. Для применения новых тарифов необходимо перезагрузить сервер.

## Запуск

```bash
git clone https://github.com/helpacc/cost_calculation_api.git
cd cost_calculation_api
bundle
rake # тесты
puma
```

[http://localhost:3000/swagger-ui/index.html#!/Cost/get_v1_cost](http://localhost:3000/swagger-ui/index.html#!/Cost/get_v1_cost)

## Детали API

`"cost_in_cents"` передается как целое число, чтобы избежать ошибок округления. Стоимость передается в копейках/центах, например, `cost_in_cents == 10000` будет соответствовать ста рублям. Выбор между названиями `cost` и `cost_in_cents` сделан в пользу `cost_in_cents`, чтобы избежать возможных ошибок и лишней траты времени на уточнения при реализации взаимодействия между фронтендом и бэкендом. При желании избежать ошибок при добавлении новых тарифов можно внедрить соответствующие проверки в `Tariff.load`.

Для демонстрации работы связки сервисов добавил `swagger-ui`. Для простоты описание единственного эндпоинта сделал напрямую в `public/swagger-ui/api.json`; можно генерировать ее на лету из Ruby, но в данном случае не принципиально.

## Производительность

Оценивал производительность связки из двух микросервисов. Замер проводил на MacBook Pro 2016, core i5.

```
$ ab -n 200 -c 9  'http://127.0.0.1:3000/v1/cost?from_lat=55.5&from_long=60.0&to_lat=56.5&to_long=61.0'
This is ApacheBench, Version 2.3 <$Revision: 1796539 $>

Concurrency Level:      9
Time taken for tests:   5.241 seconds
Complete requests:      200
Failed requests:        0
Total transferred:      28600 bytes
HTML transferred:       7800 bytes
Requests per second:    38.16 [#/sec] (mean)
Time per request:       235.841 [ms] (mean)
Time per request:       26.205 [ms] (mean, across all concurrent requests)
Transfer rate:          5.33 [Kbytes/sec] received

Percentage of the requests served within a certain time (ms)
  50%    226
  66%    242
  75%    254
  80%    262
  90%    314
  95%    351
  98%    422
  99%    431
 100%    470 (longest request)
```

На двухстах запросах показатели такие; если проводить замер дальше, то включается ограничение бесплатного уровня Google Maps API, и количество обрабатываемых запросов в секунду резко падает. В общем, ограничивающим фактором пока что является не скорость приложения, а лимиты Google Maps API. 

## Выбранные технологии

Использовал Ruby, т.к. необходимо было показать, прежде всего, навыки разработки на Ruby. Далее: `Sinatra` — фактически стандарт для маленьких сервисов на Ruby; `puma` в качестве вебсервера — быстрый и удобный инструмент. Горстка вспомогательных библиотек: 

- `money`: работа с деньгами. В данном сервисе можно было и без нее обойтись, но если в дальнейшем использовать тарифы в разных странах с разными валютами, будет удобнее.
- `httparty` для запросов ко второму микросервису.
- `dotenv` для удобной работы с переменными окружения.
- `rspec`, `rubocop`, `pry`, `webmock` — тоже фактически стандарт.

## Возможности для улучшения

Ниже перечислю моменты, выполнение которых в рамках задания не требовалось. При выполнении такой задачи в реальной жизни можно было бы обсудить их необходимость и приоритетность.

- Можно выдавать вместе с примерной стоимостью маршрут и предполагаемое время поездки, т.к. они, скорее всего, понадобятся на фронтенде для отображения пользователю.
- Полезно было бы реализовать эндпоинт `/tariffs`, выдающий информацию о существующих тарифах. 
- Возможно, нужна будет аутентификация/авторизация в каком-либо виде.
